<!DOCTYPE html>
<html>

<head>
    <title>Chat</title>
</head>

<body>
    <h1>WebSocket Chat</h1>
    <h2>Your ID: <span id="ws-id"></span></h2>
    <hr>
    <input type="text" value="" id="application_name" placeholder="application_name">
    <input type="text" value="" id="user_id" placeholder="hashed user id">
    <button onclick="reconnect()">Connect</button>
    <hr>
    <form action="" onsubmit="sendMessage(event)">
        <input type="text" id="messageText" autocomplete="off" />
        <button>Send</button>
    </form>
    <ul id='messages'>
    </ul>
    <script>
        var ws_url = "ws://localhost:8000/api/latest/swipe_sessions"

        const actions = {
            REQUEST_SESSION_MESSAGE: "REQUEST_SESSION_MESSAGE",
            REQUEST_GLOBAL_MESSAGE: "REQUEST_GLOBAL_MESSAGE",
            REQUEST_RECIPE_LIKE: "REQUEST_RECIPE_LIKE",

            RESPONSE_CONNECTION_CODE: "RESPONSE_CONNECTION_CODE",
            RESPONSE_SESSION_MESSAGE: "RESPONSE_SESSION_MESSAGE",
            RESPONSE_GLOBAL_MESSAGE: "RESPONSE_GLOBAL_MESSAGE",
            RESPONSE_RECIPE_MATCH: "RESPONSE_RECIPE_MATCH"
        }

        var client_id = Date.now()
        var application_name = ""
        var user_id = ""
        document.querySelector("#ws-id").textContent = client_id;

        var ws = null //new WebSocket(`${ws_url}/${application_name}/${client_id}`);
        // ws = setOnMessage(ws);

        function setOnMessage(ws) {
            ws.onmessage = function (event) {
                console.log(event.data)
                var data = JSON.parse(event.data)
                var messages = document.getElementById('messages')

                var message = document.createElement('li')
                var content = document.createTextNode(data.message)
                message.appendChild(content)
                messages.appendChild(message)
            };
            return ws;
        }

        function reconnect() {
            if (ws) ws.close()

            application_name = document.getElementById("application_name").value
            user_id = document.getElementById("user_id").value
            ws = new WebSocket(`${ws_url}/${application_name}/${user_id}`);
            ws.onerror = function (event) {
                reconnect()
            }

            ws = setOnMessage(ws);
            console.log(ws)
        }

        function sendMessage(event) {
            var input = document.getElementById("messageText")
            var payload = {
                message: input.value
            }
            var package = {
                action: actions.REQUEST_GLOBAL_MESSAGE,
                payload: payload
            }
            ws.send(JSON.stringify(package))
            input.value = ''
            event.preventDefault()
        }
    </script>
</body>

</html>